ublic class PromptScraps
{
    public (string, string) Test()
    {
        var request = new PromptRequest
        {
            SystemInstruction = "You are an assistant extracting key data from 118Money credit card statements.",
            UserPrompt = "Extract the name and current balance from the statement: [statement text here].",
            Properties =
            [
                new() { Name = "Name", Type = "string", Description = "extract name on statement" },
                new() { Name = "Balance", Type = "number", Description = "extract balance on statement" }
            ]
        };
        
        var factory = new PromptFactory();

        var chatGptPayload = factory.BuildRequest(request, new LlmConfiguration(LlmProvider.ChatGpt, "gpt-4o-mini"));
        var geminiPayload = factory.BuildRequest(request, new LlmConfiguration(LlmProvider.Gemini, "gemini-pro"));
        
        Console.WriteLine("OpenAI JSON:");
        Console.WriteLine(chatGptPayload);

        Console.WriteLine("\nGemini JSON:");
        Console.WriteLine(geminiPayload);
        
        return (chatGptPayload, geminiPayload);
    }
}

public enum LlmProvider
{
    None,
    ChatGpt,
    Gemini
}

public record LlmConfiguration(LlmProvider Provider, string Model);

public class PromptProperty
{
    public string Name { get; set; } = null!;
    public string Type { get; set; } = null!; // "string", "number"
    public string Description { get; set; } = null!;
}

public class PromptRequest
{
    public string SystemInstruction { get; set; } = null!;
    public string UserPrompt { get; set; } = null!;
    public List<PromptProperty> Properties { get; set; } = [];
}

public interface IPromptFactory
{
    string BuildRequest(PromptRequest request, LlmConfiguration provider);
    Dictionary<string, object?> ParseResponse(string jsonResponse, LlmConfiguration provider);
}

public class PromptFactory : IPromptFactory
{
    private static readonly JsonSerializerOptions SerializerOptions = new JsonSerializerOptions
        { WriteIndented = true };
    
    public string BuildRequest(PromptRequest request, LlmConfiguration llmConfiguration)
    {
        return llmConfiguration.Provider switch
        {
            LlmProvider.ChatGpt => BuildOpenAiRequest(request, llmConfiguration),
            LlmProvider.Gemini => BuildGeminiRequest(request, llmConfiguration),
            _ => throw new NotSupportedException()
        };
    }
    
    private string BuildOpenAiRequest(PromptRequest request, LlmConfiguration llmConfiguration)
    {
        var functions = new[]
        {
            new
            {
                name = "extract_key_information",
                description = "Extract key information from a statement",
                parameters = new
                {
                    type = "object",
                    properties = request.Properties.ToDictionary(
                        p => p.Name.ToLowerInvariant(),
                        p => new
                        {
                            type = "object",
                            properties = new
                            {
                                value = new { type = p.Type, description = p.Description },
                                confidence = new { type = "number", description = $"confidence score (0-100) for {p.Name}" }
                            },
                            required = new[] { "value", "confidence" }
                        }),
                    required = request.Properties.Select(p => p.Name.ToLowerInvariant()).ToArray()
                }
            }
        };

        var payload = new
        {
            model = llmConfiguration.Model,
            messages = new[]
            {
                new { role = "system", content = request.SystemInstruction },
                new { role = "user", content = request.UserPrompt }
            },
            function_call = "auto",
            functions
        };

        return JsonSerializer.Serialize(payload, SerializerOptions);
    }
    
    private string BuildGeminiRequest(PromptRequest request, LlmConfiguration llmConfiguration)
    {
        var functionDeclarations = new[]
        {
            new
            {
                name = "extract_key_information",
                description = "Extract key information from a statement",
                parameters = new
                {
                    type = "object",
                    properties = request.Properties.ToDictionary(
                        p => p.Name.ToLowerInvariant(),
                        p => new
                        {
                            type = "object",
                            properties = new
                            {
                                value = new { type = p.Type, description = p.Description },
                                confidence = new { type = "number", description = $"confidence score (0-100) for {p.Name}" }
                            },
                            required = new[] { "value", "confidence" }
                        }),
                    required = request.Properties.Select(p => p.Name.ToLowerInvariant()).ToArray()
                }
            }
        };

        var payload = new
        {
            model = $"models/{llmConfiguration.Model}",
            system_instruction = new
            {
                parts = new[] { new { text = request.SystemInstruction } }
            },
            contents = new[]
            {
                new { role = "user", parts = new[] { new { text = request.UserPrompt } } }
            },
            tools = new[]
            {
                new { function_declarations = functionDeclarations }
            },
            tool_config = new { function_calling = "AUTO" }
        };

        return JsonSerializer.Serialize(payload, new JsonSerializerOptions { WriteIndented = true });
    }
    
    public Dictionary<string, object?> ParseResponse(string jsonResponse, LlmConfiguration llmConfiguration)
    {
        using var doc = JsonDocument.Parse(jsonResponse);
        var result = new Dictionary<string, object?>();

        switch (llmConfiguration.Provider)
        {
            case LlmProvider.ChatGpt:
                // Example path: choices[0].message.function_call.arguments
                var args = doc.RootElement
                    .GetProperty("choices")[0]
                    .GetProperty("message")
                    .GetProperty("function_call")
                    .GetProperty("arguments")
                    .GetRawText();
                result = JsonSerializer.Deserialize<Dictionary<string, object?>>(args)!;
                break;

            case LlmProvider.Gemini:
                // Example path: candidates[0].content.parts[0].functionCall.args
                var gemArgs = doc.RootElement
                    .GetProperty("candidates")[0]
                    .GetProperty("content")
                    .GetProperty("parts")[0]
                    .GetProperty("functionCall")
                    .GetProperty("args")
                    .GetRawText();
                result = JsonSerializer.Deserialize<Dictionary<string, object?>>(gemArgs)!;
                break;
        }

        return result;
    }
}



public sealed class OwnerRequirement : IAuthorizationRequirement
{
    public static OwnerRequirement Instance { get; } = new();
    private OwnerRequirement() {}
}

public sealed class DepartmentMemberRequirement : IAuthorizationRequirement
{
    public static DepartmentMemberRequirement Instance { get; } = new();
    private DepartmentMemberRequirement() {}
}

// Resource: only the owner may access
public sealed class OwnerAuthHandler : AuthorizationHandler<OwnerRequirement, Resource>
{
    protected override Task HandleRequirementAsync(
        AuthorizationHandlerContext context, OwnerRequirement requirement, Resource resource)
    {
        var userId = context.User.FindFirstValue(ClaimTypes.NameIdentifier);
        if (userId != null && Guid.TryParse(userId, out var id) && id == resource.OwnerUserId)
            context.Succeed(requirement);

        return Task.CompletedTask;
    }
}

// Department: only users assigned to that department
public sealed class DepartmentMemberHandler : AuthorizationHandler<DepartmentMemberRequirement, Department>
{
    protected override Task HandleRequirementAsync(
        AuthorizationHandlerContext context, DepartmentMemberRequirement requirement, Department department)
    {
        var claim = context.User.FindFirst("dept")?.Value;
        if (claim != null && Guid.TryParse(claim, out var deptId) && deptId == department.Id)
            context.Succeed(requirement);

        return Task.CompletedTask;
    }
}

// builder.Services.AddAuthorization();
// builder.Services.AddSingleton<IAuthorizationHandler, OwnerAuthHandler>();
// builder.Services.AddSingleton<IAuthorizationHandler, DepartmentMemberHandler>();


// app.MapGet("/resources/{id:guid}", async (
//     Guid id, ClaimsPrincipal user, IAuthorizationService authz, AppDb db) =>
// {
//     var entity = await db.Resources.AsNoTracking().SingleOrDefaultAsync(r => r.Id == id);
//     if (entity is null) return Results.NotFound();
//
//     var result = await authz.AuthorizeAsync(user, entity, OwnerRequirement.Instance);
//     return result.Succeeded ? Results.Ok(entity) : Results.Forbid();
// }).RequireAuthorization();


// // GET /departments/{id} â€” only members of that department can read
// app.MapGet("/departments/{id:guid}", async (
//     Guid id, ClaimsPrincipal user, IAuthorizationService authz, AppDb db) =>
// {
//     var dept = await db.Departments.AsNoTracking().SingleOrDefaultAsync(d => d.Id == id);
//     if (dept is null) return Results.NotFound();
//
//     var result = await authz.AuthorizeAsync(user, dept, DepartmentMemberRequirement.Instance);
//     return result.Succeeded ? Results.Ok(dept) : Results.Forbid();
// }).RequireAuthorization();


// // List my resources only
// app.MapGet("/resources", async (ClaimsPrincipal user, AppDb db) =>
// {
//     var uid = GetUserId(user) ?? Guid.Empty;
//     var items = await db.Resources.Where(r => r.OwnerUserId == uid).ToListAsync();
//     return Results.Ok(items);
// }).RequireAuthorization();
//
// // List only my department
// app.MapGet("/departments/me", (ClaimsPrincipal user) =>
// {
//     var deptId = GetDeptId(user);
//     return deptId is null ? Results.Forbid() : Results.Redirect($"/departments/{deptId}");
// }).RequireAuthorization();

public class Resource
{
    public Guid Id { get; set; }
    public Guid OwnerUserId { get; set; }
    public User Owner { get; set; } = default!;
}

public class User
{
    public Guid Id { get; set; }
    public Guid DepartmentId { get; set; }
    public Department Department { get; set; } = default!;
    public ICollection<Resource> Resources { get; set; } = new List<Resource>();
}

public class Department
{
    public Guid Id { get; set; }
    public string Name { get; set; } = "";
}
